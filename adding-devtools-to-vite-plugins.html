<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width" name=viewport> <link href=./_app/immutable/assets/Metadata.DyfCrczt.css rel=stylesheet> <link href=./_app/immutable/assets/3.CqjOwtjT.css rel=stylesheet> <link href=./_app/immutable/entry/start.DB3qzB1x.js rel=modulepreload> <link href=./_app/immutable/chunks/entry.R9RbXgNo.js rel=modulepreload> <link href=./_app/immutable/chunks/scheduler.DwkGEAYb.js rel=modulepreload> <link href=./_app/immutable/chunks/index.CU0sutvA.js rel=modulepreload> <link href=./_app/immutable/entry/app.Cxu8KuB6.js rel=modulepreload> <link href=./_app/immutable/chunks/preload-helper.CP-VSAQc.js rel=modulepreload> <link href=./_app/immutable/chunks/index.BoYP9eQs.js rel=modulepreload> <link href=./_app/immutable/nodes/0.CMIPQFkk.js rel=modulepreload> <link href=./_app/immutable/nodes/2.DHflZWwR.js rel=modulepreload> <link href=./_app/immutable/chunks/Metadata.Dw_YWALZ.js rel=modulepreload> <link href=./_app/immutable/chunks/stores.CyJ70CA2.js rel=modulepreload> <link href=./_app/immutable/chunks/each.CuygwpM4.js rel=modulepreload> <link href=./_app/immutable/chunks/theme.COyUI6g7.js rel=modulepreload> <link href=./_app/immutable/nodes/3.BMPqw2Om.js rel=modulepreload> <link href=./_app/immutable/nodes/6.Cm6WBkrv.js rel=modulepreload><title>Adding Devtools to Vite plugins</title><!-- HEAD_svelte-1quh51c_START --><script data-svelte-h=svelte-ctkbxh>if("localStorage"in window){let e="dark"===localStorage.getItem("theme"),t="light"===localStorage.getItem("theme"),a=!e&&!t;if(e)document.documentElement.classList.add("dark");else if(t)document.documentElement.classList.remove("dark");else if(a){let e=window.matchMedia("(prefers-color-scheme: dark)");e.matches?(document.documentElement.classList.add("dark"),localStorage.setItem("theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("theme","light"))}}</script><!-- HEAD_svelte-1quh51c_END --><!-- HEAD_svelte-170d11p_START --><meta content="Adding Devtools to Vite plugins" name=og:title><meta content="Adding Devtools to Vite plugins" name=twitter:title><meta content=website name=og:type> <meta content=/og/Adding%20Devtools%20to%20Vite%20plugins.png name=og:image><link href=/_app/immutable/assets/favicon.BtYv9CGA.png rel=icon><meta content="Many frontend frameworks and tools come in the form of Vite-plugins. Here is how plugin authors can inject devtools into the browser during development." name=description><meta content="Loris Sigrist" name=author><meta content=2023-10-05T00:00:00.000Z name=date><!-- HEAD_svelte-170d11p_END --> </head> <body data-sveltekit-preload-data=hover> <header class="flex flex-row container justify-between mx-auto print:hidden px-4 py-4"><div class="flex items-center flex-row gap-4" id=header-start data-svelte-h=svelte-1la7e6x><a href=/ class="flex items-center flex-row gap-3"><picture><source srcset="/_app/immutable/assets/avatar.Bf4TRO7F.avif, /_app/immutable/assets/avatar.BkqM9Qx8.avif 2x" type=image/avif><source srcset="/_app/immutable/assets/avatar.B39wt1fA.webp, /_app/immutable/assets/avatar.D9hkS3v8.webp 2x" type=image/webp><source srcset="/_app/immutable/assets/avatar.nNTP_Lha.png, /_app/immutable/assets/avatar.B3igIkfZ.png 2x" type=image/png><img alt="Loris Sigrist looking very handsome" class="aspect-square rounded-full w-9" height=412 src=/_app/immutable/assets/avatar.B3igIkfZ.png width=412></picture> <span class="font-bold text-md">Loris Sigrist</span></a></div> <div class="flex items-center gap-2 flex-row sm:gap-4" id=header-end><a href=https://dithering.sigrist.dev class="flex items-center gap-2 rounded-md dark:text-gray-200 hover:bg-gray-100 hover:dark:bg-gray-800 p-1 sm:px-3 text-gray-800" target=_blank data-svelte-h=svelte-1ilvshw><span class="hidden sm:block">Dither Studio</span></a> <a href=https://zocker.sigrist.dev/ class="flex items-center gap-2 rounded-md dark:text-gray-200 hover:bg-gray-100 hover:dark:bg-gray-800 p-1 sm:px-3 text-gray-800" target=_blank data-svelte-h=svelte-1tefg7x><span class="hidden sm:block">Zocker</span></a> <a href=https://t18s.sigrist.dev/ class="flex items-center gap-2 rounded-md dark:text-gray-200 hover:bg-gray-100 hover:dark:bg-gray-800 p-1 sm:px-3 text-gray-800" target=_blank data-svelte-h=svelte-1spq4jh><span class="hidden sm:block">t18s</span></a> <a href=https://www.github.com/LorisSigrist class="flex items-center gap-2 rounded-md dark:text-gray-200 hover:bg-gray-100 hover:dark:bg-gray-800 p-1 sm:px-3 text-gray-800" target=_blank><span><svg class="h-4 w-4" fill=none height=1024 viewBox="0 0 1024 1024" width=1024 xmlns=http://www.w3.org/2000/svg><path d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" clip-rule=evenodd fill=currentColor fill-rule=evenodd transform=scale(64)></path></svg></span> <span class="hidden sm:block" data-svelte-h=svelte-1ob2gl>Github</span></a> <a href=mailto:loris@sigrist.dev class="flex items-center gap-2 rounded-md bg-black dark:bg-white dark:text-black md:px-3 px-1 py-1 text-white"><svg class="h-4 w-4" fill=none height=100% viewBox="0 0 24 24" width=100% xmlns=http://www.w3.org/2000/svg aria-hidden=true stroke=currentColor stroke-width=1.5><path d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" stroke-linecap=round stroke-linejoin=round></path></svg> <span class="hidden md:block" data-svelte-h=svelte-lz17j7>Contact</span></a> <button class="rounded-md hover:bg-gray-100 hover:dark:bg-gray-800 aspect-square p-2" title="Toggle Theme"> <div class="contents dark:hidden"><svg class="h-4 w-4" fill=none height=100% viewBox="0 0 24 24" width=100% xmlns=http://www.w3.org/2000/svg aria-hidden=true stroke=currentColor stroke-width=1.5 slot=light><path d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" stroke-linecap=round stroke-linejoin=round></path></svg></div> <div class="hidden dark:contents"><svg class="h-4 w-4" fill=none height=100% viewBox="0 0 24 24" width=100% xmlns=http://www.w3.org/2000/svg aria-hidden=true stroke=currentColor stroke-width=1.5 slot=dark><path d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" stroke-linecap=round stroke-linejoin=round></path></svg></div></button></div></header> <article class="container mx-auto px-4 dark:prose-invert max-w-[70ch] my-8 print:m-0 print:p-0 print:w-100 prose prose-slate"><h1 data-svelte-h=svelte-149hxn8 id=adding-devtools-to-vite-plugins><a href=#adding-devtools-to-vite-plugins>Adding Devtools to Vite plugins</a></h1> <p data-svelte-h=svelte-f4e11x>One of my favorite features in any framework is the <em>Svelte Inspector</em>. It allows you to click on a component and then it magically opens the relevant file in your editor.</p> <p data-svelte-h=svelte-1gnlx2z>In order to accomplish this, without the user’s having to do additional setup, they have to inject their devtool code into the browser during development. Today we will learn how to do that, so that you too can build great devtools!</p> <h2 data-svelte-h=svelte-13bm82k id=getting-a-foothold---injecting-js-into-the-browser><a href=#getting-a-foothold---injecting-js-into-the-browser>Getting a Foothold - Injecting JS into the Browser</a></h2> <p data-svelte-h=svelte-139m8pm>The key is to inject code into vite’s client side entry point. This is surprisingly straight forward since a vite-plugin can just modify any js file using the <code>transform</code> hook.</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark lsp twoslash" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#758575DD>/** </span><span style=color:#666>@</span><span style=color:#4d9375>returns</span><span style=color:#666> {</span><span style=color:#5da994>import('vite').Plugin</span><span style=color:#666>}</span><span style=color:#758575DD> */</span></span>
<span class=line><span style=color:#cb7676>const </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#80a665>devtoolsPlugin</span><span style=color:#666>: () => </span><span style=color:#cb7676>import</span><span style=color:#666>(</span><span style=color:#c98A7D99>'</span><span style=color:#c98a7d>vite</span><span style=color:#c98A7D99>'</span><span style=color:#666>).</span><span style=color:#5da994>Plugin</span></code><div class="twoslash-popup-docs twoslash-popup-docs-tags"><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@returns</span></span></div></span>devtoolsPlugin</span></span><span style=color:#666> =</span><span style=color:#666> ()</span><span style=color:#666> =></span><span style=color:#666> ({</span></span>
<span class=line><span style=color:#b8a965>  </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>OutputPlugin</span><span style=color:#666>.</span><span style=color:#bd976a>name</span><span style=color:#dbd7CAEE>: </span><span style=color:#bd976a>string</span></code></span>name</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>devtools</span><span style=color:#c98A7D99>"</span><span style=color:#666>,</span></span>
<span class=line><span style=color:#b8a965>  </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>Plugin</span><span style=color:#666>&lt;</span><span style=color:#bd976a>any</span><span style=color:#666>>.</span><span style=color:#bd976a>enforce</span><span style=color:#cb7676>?:</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>pre</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> |</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>post</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span></code><div class=twoslash-popup-docs>Enforce plugin invocation tier similar to webpack loaders.

Plugin invocation order:
- alias resolution
- `enforce: 'pre'` plugins
- vite core plugins
- normal plugins
- vite build plugins
- `enforce: 'post'` plugins
- vite build post plugins</div></span>enforce</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>pre</span><span style=color:#c98A7D99>"</span><span style=color:#666>, </span><span style=color:#758575DD>//run before the vite's built-in transformations</span></span>
<span class=line><span style=color:#b8a965>  </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>Plugin</span><span style=color:#666>&lt;</span><span style=color:#bd976a>any</span><span style=color:#666>>.</span><span style=color:#bd976a>apply</span><span style=color:#cb7676>?:</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>serve</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> |</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>build</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> |</span><span style=color:#666> ((</span><span style=color:#c99076>this</span><span style=color:#666>: </span><span style=color:#5da994>void</span><span style=color:#666>,</span><span style=color:#bd976a> config</span><span style=color:#666>: </span><span style=color:#5da994>UserConfig</span><span style=color:#666>,</span><span style=color:#bd976a> env</span><span style=color:#666>: </span><span style=color:#5da994>ConfigEnv</span><span style=color:#666>)</span><span style=color:#666> =></span><span style=color:#bd976a> boolean</span><span style=color:#666>)</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span></code><div class=twoslash-popup-docs>Apply the plugin only for serve or build, or on certain conditions.</div></span>apply</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>serve</span><span style=color:#c98A7D99>"</span><span style=color:#666>, </span><span style=color:#758575DD>//only run in dev mode</span></span>
<span class=line><span style=color:#80a665>  </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#bd976a>Plugin</span><span style=color:#666>&lt;</span><span style=color:#bd976a>any</span><span style=color:#666>>.</span><span style=color:#bd976a>transform</span><span style=color:#cb7676>?:</span><span style=color:#bd976a> ObjectHook</span><span style=color:#666>&lt;(</span><span style=color:#c99076>this</span><span style=color:#666>: </span><span style=color:#5da994>TransformPluginContext</span><span style=color:#666>,</span><span style=color:#bd976a> code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>,</span><span style=color:#bd976a> id</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>,</span><span style=color:#bd976a> options</span><span style=color:#cb7676>?</span><span style=color:#666>: {</span></span>
<span class=line><span style=color:#bd976a>    ssr</span><span style=color:#cb7676>?</span><span style=color:#666>: </span><span style=color:#5da994>boolean</span><span style=color:#666> | </span><span style=color:#cb7676>undefined</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>} | </span><span style=color:#cb7676>undefined</span><span style=color:#666>)</span><span style=color:#666> =></span><span style=color:#bd976a> TransformResult</span><span style=color:#cb7676> |</span><span style=color:#b8a965> Promise</span><span style=color:#666>&lt;...</span><span style=color:#cb7676>>></span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span></span></code></pre></code></span>transform</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>code</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>id</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#80a665>options</span><span style=color:#666>:</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#bd976a>    ssr</span><span style=color:#cb7676>?:</span><span style=color:#bd976a> boolean</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span></span></code></pre></code></span>options</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>    if</span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#80a665>options</span><span style=color:#666>:</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#bd976a>    ssr</span><span style=color:#cb7676>?:</span><span style=color:#bd976a> boolean</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span></span></code></pre></code></span>options</span></span><span style=color:#666>?.</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>ssr</span><span style=color:#cb7676>?:</span><span style=color:#bd976a> boolean</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span></code></span>ssr</span></span><span style=color:#666>) </span><span style=color:#4d9375>return</span><span style=color:#758575DD> //Don't run in SSR mode</span></span>
<span class=line></span>
<span class=line><span style=color:#758575DD>    //Inject some code into the vite's client side entry point</span></span>
<span class=line><span style=color:#4d9375>    if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>id</span></span><span style=color:#666>.</span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>String</span><span style=color:#666>.</span><span style=color:#80a665>includes</span><span style=color:#666>(</span><span style=color:#bd976a>searchString</span><span style=color:#dbd7CAEE>: </span><span style=color:#bd976a>string</span><span style=color:#666>,</span><span style=color:#bd976a> position</span><span style=color:#cb7676>?:</span><span style=color:#bd976a> number</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span><span style=color:#666>)</span><span style=color:#dbd7CAEE>: </span><span style=color:#bd976a>boolean</span></code><div class=twoslash-popup-docs>Returns true if searchString appears as a substring of the result of converting this
object to a String, at one or more positions that are
greater than or equal to position; otherwise, returns false.</div><div class="twoslash-popup-docs twoslash-popup-docs-tags"><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@param</span><span class=twoslash-popup-docs-tag-value>searchString search string</span></span><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@param</span><span class=twoslash-popup-docs-tag-value>position If position is undefined, 0 is assumed, so as to search all of the String.</span></span></div></span>includes</span></span><span style=color:#666>(</span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>vite/dist/client/client.mjs</span><span style=color:#c98A7D99>"</span><span style=color:#666>)) {</span></span>
<span class=line><span style=color:#4d9375>      return</span><span style=color:#666> { </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>code</span><span style=color:#cb7676>?:</span><span style=color:#bd976a> string</span><span style=color:#cb7676> |</span><span style=color:#cb7676> undefined</span></code></span>code</span></span><span style=color:#666>: </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>code</span></span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c99076>\n</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>console.log('Hello World!')</span><span style=color:#c98A7D99>"</span><span style=color:#666> }</span></span>
<span class=line><span style=color:#666>    }</span></span>
<span class=line><span style=color:#666>  }</span></span>
<span class=line><span style=color:#666>})</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-dykwd4>Opening the dev-site now shows the message in the console. That’s the foothold we need.</p> <h2 data-svelte-h=svelte-wuufpu id=importing-our-own-modules><a href=#importing-our-own-modules>Importing our own modules</a></h2> <p data-svelte-h=svelte-1q4s0sc>But to ship non-trivial devtools, we need more than just a foothold. We need more than just appending some code at the end of a file. We need to import our own modules.</p> <p data-svelte-h=svelte-1kcsokb>Unfortunately, this isn’t so straight forward. Our plugin is likely part of an external package and we don’t know where that package will be installed, so we can’t import our own modules using relative paths.</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark lsp twoslash" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a>plugin</span><span style=color:#666>: {</span></span>
<span class=line><span style=color:#80a665>    transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>): {</span></span>
<span class=line><span style=color:#bd976a>        code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>    } | </span><span style=color:#cb7676>undefined</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre></code></span>plugin</span></span><span style=color:#666> =</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#80a665>  </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>function</span><span style=color:#80a665> transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>):</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#bd976a>    code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span><span style=color:#666> |</span><span style=color:#cb7676> undefined</span></span></code></pre></code></span>transform</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>options</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>options</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>    if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>.</span><span style=color:#80a665>includes</span><span style=color:#666>(</span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>vite/dist/client/client.mjs</span><span style=color:#c98A7D99>"</span><span style=color:#666>)) {</span></span>
<span class=line><span style=color:#758575DD>      // How do we import our own modules?</span></span>
<span class=line><span style=color:#4d9375>      return</span><span style=color:#666> { </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>code</span></span><span style=color:#666>: </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c99076>\n</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>import(????)</span><span style=color:#c98A7D99>"</span><span style=color:#666> }</span></span>
<span class=line><span style=color:#666>    }</span></span>
<span class=line><span style=color:#666>  }</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-ujsyuk>I offer a few solutions here:</p> <ol data-svelte-h=svelte-1de6fwn><li>Export the devtools browser code from the plugin package</li> <li>Use a sub-package</li> <li>Magic Module Resolution (preferred)</ol> <h3 data-svelte-h=svelte-hi4waj id=option-1-exporting-the-runtime-code-from-the-package><a href=#option-1-exporting-the-runtime-code-from-the-package>Option 1: Exporting the runtime code from the package</a></h3> <p data-svelte-h=svelte-18yov4n>This one is very straight forward. We just export the entry point of our devtools from our package. This way all we need to do is to inject an import statement to it in the client side js.</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark lsp twoslash" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#758575DD>// @filename: entry.js</span></span>
<span class=line><span style=color:#4d9375>export</span><span style=color:#cb7676> function</span><span style=color:#80a665> </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> bootstrapDevtools</span><span style=color:#666>():</span><span style=color:#5da994> void</span></code></span>bootstrapDevtools</span></span><span style=color:#666>()</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#758575DD>    // Devtool Browser code here</span></span>
<span class=line><span style=color:#666>}</span></span>
<span class=line></span>
<span class=line><span style=color:#758575DD>// @filename: plugin.js</span></span>
<span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a>plugin</span><span style=color:#666>: {</span></span>
<span class=line><span style=color:#80a665>    transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>): {</span></span>
<span class=line><span style=color:#bd976a>        code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>    } | </span><span style=color:#cb7676>undefined</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre></code></span>plugin</span></span><span style=color:#666> =</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#80a665>  </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>function</span><span style=color:#80a665> transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>):</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#bd976a>    code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span><span style=color:#666> |</span><span style=color:#cb7676> undefined</span></span></code></pre></code></span>transform</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>options</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>options</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>    if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>.</span><span style=color:#80a665>includes</span><span style=color:#666>(</span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>vite/dist/client/client.mjs</span><span style=color:#c98A7D99>"</span><span style=color:#666>)) {</span></span>
<span class=line><span style=color:#4d9375>      return</span><span style=color:#666> { </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>code</span></span><span style=color:#666>: </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c99076>\n</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> '</span><span style=color:#c98a7d>import("my-devtools-plugin").then(module => module.bootstrapDevtools())</span><span style=color:#c98A7D99>'</span><span style=color:#666> }</span></span>
<span class=line><span style=color:#666>    }</span></span>
<span class=line><span style=color:#666>  }</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-d8lfxd>This works and is very simple, but it has some downsides.</p> <ul data-svelte-h=svelte-8xnolz><li>It clutters up the exports of our package.</li> <li>It mixes browser code with plugin code.</ul> <blockquote data-svelte-h=svelte-1mtvoal><p>It’s probably possible to hide the export from the IDE by modifying the package’s type definitions, but that’s more work than the other solutions.</blockquote> <h3 data-svelte-h=svelte-13xa7ud id=option-2-using-a-sub-package><a href=#option-2-using-a-sub-package>Option 2: Using a sub-package</a></h3> <p data-svelte-h=svelte-ok68q6>Sub packages are a feature of npm that allow you to have multiple entry points in a single package. For example, the <code>svelte</code> package has a sub-package <code>svelte/stores</code> which contains store implementations.</p> <p data-svelte-h=svelte-anwskw>In this approach, we still export the runtime code from our package, but we give it it’s own entry point. This way we don’t clutter up the exports and we don’t mix concerns.</p> <p data-svelte-h=svelte-hih30e>Here is the setup:</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span>src</span></span>
<span class=line><span>|- plugin.js</span></span>
<span class=line><span>|- devtools</span></span>
<span class=line><span>   |- entry.js</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-tqh44r>Then, in the <code>package.json</code>, add an exports field with two entries: one for the plugin and one for the devtools.</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#666>{</span></span>
<span class=line><span style=color:#c98A7D99>  "</span><span style=color:#b8a965>name</span><span style=color:#c98A7D99>"</span><span style=color:#666>:</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>my-devtools-plugin</span><span style=color:#c98A7D99>"</span><span style=color:#666>,</span></span>
<span class=line><span style=color:#c98A7D99>  "</span><span style=color:#b8a965>exports</span><span style=color:#c98A7D99>"</span><span style=color:#666>:</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#c98A7D99>    "</span><span style=color:#b8a965>.</span><span style=color:#c98A7D99>"</span><span style=color:#666>:</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#c98A7D99>        "</span><span style=color:#b8a965>import</span><span style=color:#c98A7D99>"</span><span style=color:#666>:</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>./plugin.js</span><span style=color:#c98A7D99>"</span><span style=color:#666>,</span></span>
<span class=line><span style=color:#c98A7D99>        "</span><span style=color:#b8a965>types</span><span style=color:#c98A7D99>"</span><span style=color:#666>:</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>./plugin.d.ts</span><span style=color:#c98A7D99>"</span></span>
<span class=line><span style=color:#666>    },</span></span>
<span class=line><span style=color:#c98A7D99>    "</span><span style=color:#b8a965>./internal</span><span style=color:#c98A7D99>"</span><span style=color:#666>:</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#c98A7D99>        "</span><span style=color:#b8a965>import</span><span style=color:#c98A7D99>"</span><span style=color:#666>:</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>./devtools/entry.js</span><span style=color:#c98A7D99>"</span></span>
<span class=line><span style=color:#666>    }</span></span>
<span class=line><span style=color:#666>  }</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-zeazju>You can then inject an import statement to <code>my-devtools-plugin/internal</code> in the client side js.</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark lsp twoslash" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a>plugin</span><span style=color:#666>: {</span></span>
<span class=line><span style=color:#80a665>    transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>): {</span></span>
<span class=line><span style=color:#bd976a>        code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>    } | </span><span style=color:#cb7676>undefined</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre></code></span>plugin</span></span><span style=color:#666> =</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#80a665>  </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>function</span><span style=color:#80a665> transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>):</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#bd976a>    code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span><span style=color:#666> |</span><span style=color:#cb7676> undefined</span></span></code></pre></code></span>transform</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>options</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>options</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>    if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>.</span><span style=color:#80a665>includes</span><span style=color:#666>(</span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>vite/dist/client/client.mjs</span><span style=color:#c98A7D99>"</span><span style=color:#666>)) {</span></span>
<span class=line><span style=color:#4d9375>      return</span><span style=color:#666> { </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>code</span></span><span style=color:#666>: </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c99076>\n</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> '</span><span style=color:#c98a7d>import("my-devtools-plugin/internal").then(module => module.bootstrap())</span><span style=color:#c98A7D99>'</span><span style=color:#666> }</span></span>
<span class=line><span style=color:#666>    }</span></span>
<span class=line><span style=color:#666>  }</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-mk2ame>This eliminates the code-mixing problem, but does not quite eliminated the import cluttering. While the <code>my-devtools-plugin</code> package does not have private exports, IDEs might still suggest <code>my-devtools-plugin/internal</code> as an import option. Developers are unlikely to use it, but it’s still a bit annoying.</p> <blockquote data-svelte-h=svelte-4otrga><p>If you generate your type definitions using <a href=https://www.github.com/Rich-Harris/dts-buddy target=_blank rel="noopener noreferrer"><code>dts-buddy</code></a> instead of <code>tsc</code>, you can sidestep this problem by not generating type declarations for the <code>internal</code> sub-package. Otherwise use Option 3.</blockquote> <h3 data-svelte-h=svelte-1vol08d id=option-3-magic-module-resolution-preferred><a href=#option-3-magic-module-resolution-preferred>Option 3: Magic Module Resolution (preferred)</a></h3> <p data-svelte-h=svelte-d4i2kr>If you <em>really</em> don’t want to clutter your exports, this is the best way to go, but it’s a bit of work to set up.</p> <p data-svelte-h=svelte-1bug3ei>The idea is to define a magic module-id that our plugin resolves to the absolute path of our entry point.</p> <p data-svelte-h=svelte-1kdpnj3>(Eg: <code>import("my-package:devtools")</code> resolves to <code>import("/home/user/project/node_modules/my-package/devtools/entry.js")</code> or whatever)</p> <p data-svelte-h=svelte-qoqrfj>But how can we know the absolute path of our entry point? The trick is that we know the relative path to the entry point <em>from</em> our plugin file.</p> <p data-svelte-h=svelte-m7512w>We can get the absolute path of our plugin’s file using <code>import.meta.url</code>. We can then combine that with the relative path to our entry point to get the absolute path to our entry point.</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span>src</span></span>
<span class=line><span>|- plugin.js</span></span>
<span class=line><span>|- devtools</span></span>
<span class=line><span>   |- entry.js</span></span></code></pre><!-- HTML_TAG_END --> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark lsp twoslash" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#4d9375>import</span><span style=color:#666> {</span><span style=color:#bd976a> </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#666> (</span><span style=color:#bd976a>method</span><span style=color:#666>)</span><span style=color:#80a665> dirname</span><span style=color:#666>(</span><span style=color:#bd976a>path</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>):</span><span style=color:#5da994> string</span></code><div class=twoslash-popup-docs>Return the directory name of a path. Similar to the Unix dirname command.</div><div class="twoslash-popup-docs twoslash-popup-docs-tags"><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@param</span><span class=twoslash-popup-docs-tag-value>path the path to evaluate.</span></span><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@throws</span><span class=twoslash-popup-docs-tag-value>{TypeError} if `path` is not a string.</span></span></div></span>dirname</span></span><span style=color:#666> }</span><span style=color:#4d9375> from</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>node:path</span><span style=color:#c98A7D99>"</span></span>
<span class=line><span style=color:#4d9375>import</span><span style=color:#666> {</span><span style=color:#bd976a> </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> fileURLToPath</span><span style=color:#666>(</span><span style=color:#bd976a>url</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666> | </span><span style=color:#5da994>URL</span><span style=color:#666>,</span><span style=color:#bd976a> options</span><span style=color:#cb7676>?</span><span style=color:#666>: </span><span style=color:#5da994>FileUrlToPathOptions</span><span style=color:#666>):</span><span style=color:#5da994> string</span></code><div class=twoslash-popup-docs>This function ensures the correct decodings of percent-encoded characters as
well as ensuring a cross-platform valid absolute path string.

```js
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);

new URL('file:///C:/path/').pathname;      // Incorrect: /C:/path/
fileURLToPath('file:///C:/path/');         // Correct:   C:path (Windows)

new URL('file://nas/foo.txt').pathname;    // Incorrect: /foo.txt
fileURLToPath('file://nas/foo.txt');       // Correct:   \nasoo.txt (Windows)

new URL('file:///你好.txt').pathname;      // Incorrect: /%E4%BD%A0%E5%A5%BD.txt
fileURLToPath('file:///你好.txt');         // Correct:   /你好.txt (POSIX)

new URL('file:///hello world').pathname;   // Incorrect: /hello%20world
fileURLToPath('file:///hello world');      // Correct:   /hello world (POSIX)
```</div><div class="twoslash-popup-docs twoslash-popup-docs-tags"><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@since</span><span class=twoslash-popup-docs-tag-value>v10.12.0</span></span><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@param</span><span class=twoslash-popup-docs-tag-value>url The file URL string or URL object to convert to a path.</span></span><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@return</span><span class=twoslash-popup-docs-tag-value>The fully-resolved platform-specific Node.js file path.</span></span></div></span>fileURLToPath</span></span><span style=color:#666> }</span><span style=color:#4d9375> from</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>node:url</span><span style=color:#c98A7D99>"</span></span>
<span class=line><span style=color:#4d9375>import</span><span style=color:#666> {</span><span style=color:#bd976a> </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> normalizePath</span><span style=color:#666>(</span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>):</span><span style=color:#5da994> string</span></code></span>normalizePath</span></span><span style=color:#666> }</span><span style=color:#4d9375> from</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>vite</span><span style=color:#c98A7D99>"</span></span>
<span class=line></span>
<span class=line><span style=color:#cb7676>function</span><span style=color:#80a665> </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> getDevtoolsEntryPath</span><span style=color:#666>():</span><span style=color:#5da994> string</span></code></span>getDevtoolsEntryPath</span></span><span style=color:#666>()</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#cb7676>    const </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>srcFolderPath</span><span style=color:#666>: </span><span style=color:#5da994>string</span></code></span>srcFolderPath</span></span><span style=color:#666> =</span><span style=color:#80a665> </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> normalizePath</span><span style=color:#666>(</span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>):</span><span style=color:#5da994> string</span></code></span>normalizePath</span></span><span style=color:#666>(</span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> dirname</span><span style=color:#666>(</span><span style=color:#bd976a>path</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>):</span><span style=color:#5da994> string</span></code><div class=twoslash-popup-docs>Return the directory name of a path. Similar to the Unix dirname command.</div><div class="twoslash-popup-docs twoslash-popup-docs-tags"><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@param</span><span class=twoslash-popup-docs-tag-value>path the path to evaluate.</span></span><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@throws</span><span class=twoslash-popup-docs-tag-value>{TypeError} if `path` is not a string.</span></span></div></span>dirname</span></span><span style=color:#666>(</span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> fileURLToPath</span><span style=color:#666>(</span><span style=color:#bd976a>url</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666> | </span><span style=color:#5da994>URL</span><span style=color:#666>,</span><span style=color:#bd976a> options</span><span style=color:#cb7676>?</span><span style=color:#666>: </span><span style=color:#5da994>FileUrlToPathOptions</span><span style=color:#666> | </span><span style=color:#cb7676>undefined</span><span style=color:#666>):</span><span style=color:#5da994> string</span></code><div class=twoslash-popup-docs>This function ensures the correct decodings of percent-encoded characters as
well as ensuring a cross-platform valid absolute path string.

```js
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);

new URL('file:///C:/path/').pathname;      // Incorrect: /C:/path/
fileURLToPath('file:///C:/path/');         // Correct:   C:path (Windows)

new URL('file://nas/foo.txt').pathname;    // Incorrect: /foo.txt
fileURLToPath('file://nas/foo.txt');       // Correct:   \nasoo.txt (Windows)

new URL('file:///你好.txt').pathname;      // Incorrect: /%E4%BD%A0%E5%A5%BD.txt
fileURLToPath('file:///你好.txt');         // Correct:   /你好.txt (POSIX)

new URL('file:///hello world').pathname;   // Incorrect: /hello%20world
fileURLToPath('file:///hello world');      // Correct:   /hello world (POSIX)
```</div><div class="twoslash-popup-docs twoslash-popup-docs-tags"><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@since</span><span class=twoslash-popup-docs-tag-value>v10.12.0</span></span><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@param</span><span class=twoslash-popup-docs-tag-value>url The file URL string or URL object to convert to a path.</span></span><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@return</span><span class=twoslash-popup-docs-tag-value>The fully-resolved platform-specific Node.js file path.</span></span></div></span>fileURLToPath</span></span><span style=color:#666>(</span><span style=color:#4d9375>import</span><span style=color:#666>.</span><span style=color:#b8a965>meta</span><span style=color:#666>.</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>ImportMeta</span><span style=color:#666>.</span><span style=color:#bd976a>url</span><span style=color:#dbd7CAEE>: </span><span style=color:#bd976a>string</span></code><div class=twoslash-popup-docs>The absolute `file:` URL of the module.</div></span>url</span></span><span style=color:#666>)))</span></span>
<span class=line><span style=color:#4d9375>    return</span><span style=color:#bd976a> </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>srcFolderPath</span><span style=color:#666>: </span><span style=color:#5da994>string</span></code></span>srcFolderPath</span></span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>/devtools/entry.js</span><span style=color:#c98A7D99>"</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-zni08o>Using this, we can then resolve our magic module id to the absolute path of our entry point.</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark lsp twoslash" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>MAGIC_MODULE_ID</span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>my-package:devtools</span><span style=color:#c98A7D99>"</span></code></span>MAGIC_MODULE_ID</span></span><span style=color:#666> =</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>my-package:devtools</span><span style=color:#c98A7D99>"</span></span>
<span class=line></span>
<span class=line><span style=color:#4d9375>export</span><span style=color:#cb7676> const </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>const </span><span style=color:#80a665>devtoolsPlugin</span><span style=color:#666>: () => {</span></span>
<span class=line><span style=color:#bd976a>    name</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#bd976a>    enforce</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#bd976a>    apply</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#80a665>    resolveId</span><span style=color:#666>(</span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>): </span><span style=color:#5da994>any</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#80a665>    transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>): {</span></span>
<span class=line><span style=color:#bd976a>        code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>    } | </span><span style=color:#cb7676>undefined</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre></code></span>devtoolsPlugin</span></span><span style=color:#666> =</span><span style=color:#666> ()</span><span style=color:#666> =></span><span style=color:#666> ({</span></span>
<span class=line><span style=color:#b8a965>    </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>name</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>name</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>devtools</span><span style=color:#c98A7D99>"</span><span style=color:#666>,</span></span>
<span class=line><span style=color:#b8a965>    </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>enforce</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>enforce</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>pre</span><span style=color:#c98A7D99>"</span><span style=color:#666>,</span></span>
<span class=line><span style=color:#b8a965>    </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>apply</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>apply</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>serve</span><span style=color:#c98A7D99>"</span><span style=color:#666>,</span></span>
<span class=line><span style=color:#80a665>    </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> resolveId</span><span style=color:#666>(</span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>):</span><span style=color:#5da994> any</span></code></span>resolveId</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>        if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#cb7676> ===</span><span style=color:#bd976a> </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>MAGIC_MODULE_ID</span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>my-package:devtools</span><span style=color:#c98A7D99>"</span></code></span>MAGIC_MODULE_ID</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>            return</span><span style=color:#80a665> </span><span style=color:#80a665>getDevtoolsEntryPath</span><span style=color:#666>()</span></span>
<span class=line><span style=color:#666>        }</span></span>
<span class=line><span style=color:#666>    }, </span></span>
<span class=line><span style=color:#80a665>    </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>function</span><span style=color:#80a665> transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>):</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#bd976a>    code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span><span style=color:#666> |</span><span style=color:#cb7676> undefined</span></span></code></pre></code></span>transform</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>options</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>options</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>        if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>.</span><span style=color:#80a665>includes</span><span style=color:#666>(</span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>vite/dist/client/client.mjs</span><span style=color:#c98A7D99>"</span><span style=color:#666>)) {</span></span>
<span class=line><span style=color:#4d9375>            return</span><span style=color:#666> { </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>code</span></span><span style=color:#666>: </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c99076>\n</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> `</span><span style=color:#c98a7d>import("</span><span style=color:#666>${</span><span style=color:#c98a7d><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>MAGIC_MODULE_ID</span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>my-package:devtools</span><span style=color:#c98A7D99>"</span></code></span>MAGIC_MODULE_ID</span></span><span style=color:#666>}</span><span style=color:#c98a7d>").then(module => module.bootstrapDevtools())</span><span style=color:#c98A7D99>`</span><span style=color:#666> }</span></span>
<span class=line><span style=color:#666>        }</span></span>
<span class=line><span style=color:#666>    }</span></span>
<span class=line><span style=color:#666>})</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-l3cmum>If you’re going to use this, make sure that the relative path to your entry point is correct. Compiling or Bundling your plugin code may change the relative path.</p> <h4 data-svelte-h=svelte-1185fxd id=addendum-dealing-with-fsallow><a href=#addendum-dealing-with-fsallow>Addendum: Dealing with <code>fs.allow</code></a></h4> <p data-svelte-h=svelte-koxrm5><code>vite</code> has a configuration option called <code>fs.allow</code>. It decides which paths vite’s file-imports are allowed to read. This prevents path-traversal attacks. If your user’s use this and haven’t allowed paths inside your package folder the above code will break. You could just instruct them to allow these paths, but that’s not very user friendly.</p> <p data-svelte-h=svelte-16494hq>We can sidestep this by loading the code ourselves using the <code>load</code> hook and <code>fs.readFile</code>. We need to do this for all devtool files, not just the entry point.</p> <p data-svelte-h=svelte-1lbja3y>To do this, we will not use a <em>magic id</em>, but a <em>magic prefix</em>. We will check if an import id starts with the prefix, and if it does, replace the prefix with the path to our <em>src/devtools/</em> folder and load the files ourselves.</p> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span>src</span></span>
<span class=line><span>|- plugin.js</span></span>
<span class=line><span>|- devtools</span></span>
<span class=line><span>   |- entry.js</span></span>
<span class=line><span>   |- imported-by-entry.js</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h=svelte-yave0q>Eg:</p> <ul data-svelte-h=svelte-1yfszir><li>“my-package:devtools/entry.js” -> “/home/user/project/node_modules/my-package/devtools/entry.js”</li> <li>“my-package:devtools/imported-by-entry.js” -> “/home/user/project/node_modules/my-package/devtools/imported-by-entry.js</ul> <!-- HTML_TAG_START --><pre class="shiki vitesse-dark lsp twoslash" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#758575DD>// @filename: plugin.js </span></span>
<span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>srcFolderPath</span><span style=color:#666>: </span><span style=color:#5da994>any</span></code></span>srcFolderPath</span></span><span style=color:#666> =</span><span style=color:#80a665> </span><span style=color:#80a665>normalizePath</span><span style=color:#666>(</span><span style=color:#80a665>dirname</span><span style=color:#666>(</span><span style=color:#80a665>fileURLToPath</span><span style=color:#666>(</span><span style=color:#4d9375>import</span><span style=color:#666>.</span><span style=color:#b8a965>meta</span><span style=color:#666>.</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>ImportMeta</span><span style=color:#666>.</span><span style=color:#bd976a>url</span><span style=color:#dbd7CAEE>: </span><span style=color:#bd976a>string</span></code><div class=twoslash-popup-docs>The absolute `file:` URL of the module.</div></span>url</span></span><span style=color:#666>)))</span></span>
<span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>devtoolsFolderPath</span><span style=color:#666>: </span><span style=color:#5da994>string</span></code></span>devtoolsFolderPath</span></span><span style=color:#666> =</span><span style=color:#bd976a> </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>srcFolderPath</span><span style=color:#666>: </span><span style=color:#5da994>any</span></code></span>srcFolderPath</span></span><span style=color:#cb7676> + </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>/devtools</span><span style=color:#c98A7D99>"</span></span>
<span class=line></span>
<span class=line><span style=color:#cb7676>const </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>MAGIC_MODULE_PREFIX</span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>my-package:devtools</span><span style=color:#c98A7D99>"</span></code></span>MAGIC_MODULE_PREFIX</span></span><span style=color:#666> =</span><span style=color:#c98A7D99> "</span><span style=color:#c98a7d>my-package:devtools</span><span style=color:#c98A7D99>"</span></span>
<span class=line></span>
<span class=line><span style=color:#4d9375>export</span><span style=color:#cb7676> const </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>const </span><span style=color:#80a665>devtoolsPlugin</span><span style=color:#666>: () => {</span></span>
<span class=line><span style=color:#bd976a>    name</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#bd976a>    enforce</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#bd976a>    apply</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#80a665>    resolveId</span><span style=color:#666>(</span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>): </span><span style=color:#5da994>any</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#80a665>    load</span><span style=color:#666>(</span><span style=color:#bd976a>path</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>): </span><span style=color:#5da994>any</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#80a665>    transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>, </span><span style=color:#bd976a>options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>): {</span></span>
<span class=line><span style=color:#bd976a>        code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>    } | </span><span style=color:#cb7676>undefined</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span></span></code></pre></code></span>devtoolsPlugin</span></span><span style=color:#666> =</span><span style=color:#666> ()</span><span style=color:#666> =></span><span style=color:#666> ({</span></span>
<span class=line><span style=color:#b8a965>    </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>name</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>name</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>devtools</span><span style=color:#c98A7D99>"</span><span style=color:#666>,</span></span>
<span class=line><span style=color:#b8a965>    </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>enforce</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>enforce</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>pre</span><span style=color:#c98A7D99>"</span><span style=color:#666>, </span></span>
<span class=line><span style=color:#b8a965>    </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>apply</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>apply</span></span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>serve</span><span style=color:#c98A7D99>"</span><span style=color:#666>,</span></span>
<span class=line></span>
<span class=line><span style=color:#80a665>    </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> resolveId</span><span style=color:#666>(</span><span style=color:#bd976a>id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>):</span><span style=color:#5da994> any</span></code></span>resolveId</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>        if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>.</span><span style=color:#80a665>startsWith</span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>MAGIC_MODULE_PREFIX</span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>my-package:devtools</span><span style=color:#c98A7D99>"</span></code></span>MAGIC_MODULE_PREFIX</span></span><span style=color:#666>)) {</span></span>
<span class=line><span style=color:#4d9375>            return</span><span style=color:#bd976a> </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>.</span><span style=color:#80a665>replace</span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>MAGIC_MODULE_PREFIX</span><span style=color:#666>: </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>my-package:devtools</span><span style=color:#c98A7D99>"</span></code></span>MAGIC_MODULE_PREFIX</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>devtoolsFolderPath</span><span style=color:#666>: </span><span style=color:#5da994>string</span></code></span>devtoolsFolderPath</span></span><span style=color:#666>);</span></span>
<span class=line><span style=color:#666>        }</span></span>
<span class=line><span style=color:#666>    }, </span></span>
<span class=line></span>
<span class=line><span style=color:#80a665>    </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>function</span><span style=color:#80a665> load</span><span style=color:#666>(</span><span style=color:#bd976a>path</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>):</span><span style=color:#5da994> any</span></code></span>load</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>path</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>path</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>        if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>path</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>path</span></span><span style=color:#666>.</span><span style=color:#80a665>startsWith</span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>const </span><span style=color:#bd976a>devtoolsFolderPath</span><span style=color:#666>: </span><span style=color:#5da994>string</span></code></span>devtoolsFolderPath</span></span><span style=color:#666>)) {</span></span>
<span class=line><span style=color:#cb7676>            let </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>let </span><span style=color:#bd976a>cleanPath</span><span style=color:#666>: </span><span style=color:#5da994>any</span></code></span>cleanPath</span></span><span style=color:#666> =</span><span style=color:#bd976a> </span><span style=color:#bd976a>id</span><span style=color:#666>.</span><span style=color:#80a665>split</span><span style=color:#666>(</span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>?</span><span style=color:#c98A7D99>"</span><span style=color:#666>)[</span><span style=color:#4c9a91>0</span><span style=color:#666>]</span><span style=color:#cb7676> ?? </span><span style=color:#c98A7D99>""</span><span style=color:#666>; </span><span style=color:#758575DD>//remove query params</span></span>
<span class=line><span style=color:#bd976a>            </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>let </span><span style=color:#bd976a>cleanPath</span><span style=color:#666>: </span><span style=color:#5da994>any</span></code></span>cleanPath</span></span><span style=color:#666> = </span><span style=color:#bd976a>cleanId</span><span style=color:#666>.</span><span style=color:#80a665>split</span><span style=color:#666>(</span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>#</span><span style=color:#c98A7D99>"</span><span style=color:#666>)[</span><span style=color:#4c9a91>0</span><span style=color:#666>] </span><span style=color:#cb7676>??</span><span style=color:#c98A7D99> ""</span><span style=color:#666>; </span><span style=color:#758575DD>//remove hash</span></span>
<span class=line></span>
<span class=line><span style=color:#4d9375>            if</span><span style=color:#666>(</span><span style=color:#bd976a>fs</span><span style=color:#666>.</span><span style=color:#80a665>existsSync</span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>let </span><span style=color:#bd976a>cleanPath</span><span style=color:#666>: </span><span style=color:#5da994>any</span></code></span>cleanPath</span></span><span style=color:#666>)) {</span><span style=color:#4d9375>return</span><span style=color:#bd976a> </span><span style=color:#bd976a>fs</span><span style=color:#666>.</span><span style=color:#80a665>readFile</span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>let </span><span style=color:#bd976a>cleanPath</span><span style=color:#666>: </span><span style=color:#5da994>any</span></code></span>cleanPath</span></span><span style=color:#666>, </span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>utf-8</span><span style=color:#c98A7D99>"</span><span style=color:#666>) }</span></span>
<span class=line><span style=color:#4d9375>            else</span><span style=color:#666> { </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>var </span><span style=color:#bd976a>console</span><span style=color:#666>: </span><span style=color:#5da994>Console</span></code><div class=twoslash-popup-docs>The `console` module provides a simple debugging console that is similar to the
JavaScript console mechanism provided by web browsers.

The module exports two specific components:

* A `Console` class with methods such as `console.log()`, `console.error()` and `console.warn()` that can be used to write to any Node.js stream.
* A global `console` instance configured to write to [`process.stdout`](https://nodejs.org/docs/latest-v22.x/api/process.html#processstdout) and
[`process.stderr`](https://nodejs.org/docs/latest-v22.x/api/process.html#processstderr). The global `console` can be used without importing the `node:console` module.

_**Warning**_: The global console object's methods are neither consistently
synchronous like the browser APIs they resemble, nor are they consistently
asynchronous like all other Node.js streams. See the [`note on process I/O`](https://nodejs.org/docs/latest-v22.x/api/process.html#a-note-on-process-io) for
more information.

Example using the global `console`:

```js
console.log('hello world');
// Prints: hello world, to stdout
console.log('hello %s', 'world');
// Prints: hello world, to stdout
console.error(new Error('Whoops, something bad happened'));
// Prints error message and stack trace to stderr:
//   Error: Whoops, something bad happened
//     at [eval]:5:15
//     at Script.runInThisContext (node:vm:132:18)
//     at Object.runInThisContext (node:vm:309:38)
//     at node:internal/process/execution:77:19
//     at [eval]-wrapper:6:22
//     at evalScript (node:internal/process/execution:76:60)
//     at node:internal/main/eval_string:23:3

const name = 'Will Robinson';
console.warn(`Danger ${name}! Danger!`);
// Prints: Danger Will Robinson! Danger!, to stderr
```

Example using the `Console` class:

```js
const out = getStreamSomehow();
const err = getStreamSomehow();
const myConsole = new console.Console(out, err);

myConsole.log('hello world');
// Prints: hello world, to out
myConsole.log('hello %s', 'world');
// Prints: hello world, to out
myConsole.error(new Error('Whoops, something bad happened'));
// Prints: [Error: Whoops, something bad happened], to err

const name = 'Will Robinson';
myConsole.warn(`Danger ${name}! Danger!`);
// Prints: Danger Will Robinson! Danger!, to err
```</div><div class="twoslash-popup-docs twoslash-popup-docs-tags"><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@see</span><span class=twoslash-popup-docs-tag-value>[source](https://github.com/nodejs/node/blob/v22.x/lib/console.js)</span></span></div></span>console</span></span><span style=color:#666>.</span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#bd976a>Console</span><span style=color:#666>.</span><span style=color:#80a665>warn</span><span style=color:#666>(</span><span style=color:#bd976a>message</span><span style=color:#cb7676>?:</span><span style=color:#bd976a> any</span><span style=color:#666>,</span><span style=color:#666> ...</span><span style=color:#bd976a>optionalParams</span><span style=color:#dbd7CAEE>: </span><span style=color:#bd976a>any</span><span style=color:#666>[])</span><span style=color:#dbd7CAEE>: </span><span style=color:#cb7676>void</span><span style=color:#666> (</span><span style=color:#cb7676>+</span><span style=color:#4c9a91>1</span><span style=color:#bd976a> overload</span><span style=color:#666>)</span></code><div class=twoslash-popup-docs>The `console.warn()` function is an alias for 
{@link 
error
}
.</div><div class="twoslash-popup-docs twoslash-popup-docs-tags"><span class=twoslash-popup-docs-tag><span class=twoslash-popup-docs-tag-name>@since</span><span class=twoslash-popup-docs-tag-value>v0.1.100</span></span></div></span>warn</span></span><span style=color:#666>(</span><span style=color:#c98A7D99>`</span><span style=color:#c98a7d>Could not find file </span><span style=color:#666>${</span><span style=color:#c98a7d><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#cb7676>let </span><span style=color:#bd976a>cleanPath</span><span style=color:#666>: </span><span style=color:#5da994>any</span></code></span>cleanPath</span></span><span style=color:#666>}</span><span style=color:#c98A7D99>`</span><span style=color:#666>) }</span></span>
<span class=line><span style=color:#666>        }</span></span>
<span class=line><span style=color:#666>    },</span></span>
<span class=line></span>
<span class=line><span style=color:#80a665>    </span><span style=color:#80a665><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><pre class="shiki vitesse-dark" style=background-color:#121212;color:#dbd7caee tabindex=0><code><span class=line><span style=color:#cb7676>function</span><span style=color:#80a665> transform</span><span style=color:#666>(</span><span style=color:#bd976a>code</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> id</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>,</span><span style=color:#bd976a> options</span><span style=color:#666>: </span><span style=color:#5da994>any</span><span style=color:#666>):</span><span style=color:#666> {</span></span>
<span class=line><span style=color:#bd976a>    code</span><span style=color:#666>: </span><span style=color:#5da994>string</span><span style=color:#666>;</span></span>
<span class=line><span style=color:#666>}</span><span style=color:#666> |</span><span style=color:#cb7676> undefined</span></span></code></pre></code></span>transform</span></span><span style=color:#666>(</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>, </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>options</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>options</span></span><span style=color:#666>) {</span></span>
<span class=line><span style=color:#4d9375>        if</span><span style=color:#666> (</span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>id</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>id</span></span><span style=color:#666>.</span><span style=color:#80a665>includes</span><span style=color:#666>(</span><span style=color:#c98A7D99>"</span><span style=color:#c98a7d>vite/dist/client/client.mjs</span><span style=color:#c98A7D99>"</span><span style=color:#666>)) {</span></span>
<span class=line><span style=color:#4d9375>            return</span><span style=color:#666> { </span><span style=color:#b8a965><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> string</span></code></span>code</span></span><span style=color:#666>: </span><span style=color:#bd976a><span class=twoslash-hover><span class=twoslash-popup-container><code class=twoslash-popup-code><span style=color:#80a665>code</span><span style=color:#666>:</span><span style=color:#bd976a> any</span></code></span>code</span></span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> "</span><span style=color:#c99076>\n</span><span style=color:#c98A7D99>"</span><span style=color:#cb7676> +</span><span style=color:#c98A7D99> `</span><span style=color:#c98a7d>import("</span><span style=color:#666>${</span><span style=color:#c98a7d>MAGIC_MODULE_ID</span><span style=color:#666>}</span><span style=color:#c98a7d>/entry.js").then(module => module.bootstrap())</span><span style=color:#c98A7D99>`</span><span style=color:#666> }</span></span>
<span class=line><span style=color:#666>        }</span></span>
<span class=line><span style=color:#666>    }</span></span>
<span class=line><span style=color:#666>})</span></span></code></pre><!-- HTML_TAG_END --> <h2 data-svelte-h=svelte-oyeq2k id=in-conclusion><a href=#in-conclusion>In Conclusion</a></h2> <p data-svelte-h=svelte-3f38rf>It’s not hard, but it’s a hassle. Fortunately, you only need to do this once.</article> <div class="bg-blue-700 h-3 progress-bar svelte-co5fg3"></div> <script>{__sveltekit_1l6cm7m={base:new URL(".",location).pathname.slice(0,-1)};let r=document.currentScript.parentElement,n=[null,null,null,{type:"data",data:{title:"Adding Devtools to Vite plugins",description:"Many frontend frameworks and tools come in the form of Vite-plugins. Here is how plugin authors can inject devtools into the browser during development.",published:new Date(1696464e6),author:"Loris Sigrist"},uses:{}}];Promise.all([import("./_app/immutable/entry/start.DB3qzB1x.js"),import("./_app/immutable/entry/app.Cxu8KuB6.js")]).then(([e,t])=>{e.start(t,r,{node_ids:[0,2,3,6],data:n,form:null,error:null})}),"serviceWorker"in navigator&&addEventListener("load",function(){navigator.serviceWorker.register("./service-worker.js")})}</script> 