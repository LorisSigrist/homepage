(function(){"use strict";function R(t,e,r){return Math.min(Math.max(t,e),r)}/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const V=Symbol("Comlink.proxy"),$=Symbol("Comlink.endpoint"),J=Symbol("Comlink.releaseProxy"),T=Symbol("Comlink.finalizer"),x=Symbol("Comlink.thrown"),j=t=>typeof t=="object"&&t!==null||typeof t=="function",K={canHandle:t=>j(t)&&t[V],serialize(t){const{port1:e,port2:r}=new MessageChannel;return O(t,e),[r,[r]]},deserialize(t){return t.start(),tt(t)}},Q={canHandle:t=>j(t)&&x in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},U=new Map([["proxy",K],["throw",Q]]);function Z(t,e){for(const r of t)if(e===r||r==="*"||r instanceof RegExp&&r.test(e))return!0;return!1}function O(t,e=globalThis,r=["*"]){e.addEventListener("message",function s(i){if(!i||!i.data)return;if(!Z(r,i.origin)){console.warn(`Invalid origin '${i.origin}' for comlink proxy`);return}const{id:l,type:a,path:c}=Object.assign({path:[]},i.data),f=(i.data.argumentList||[]).map(m);let o;try{const u=c.slice(0,-1).reduce((n,g)=>n[g],t),d=c.reduce((n,g)=>n[g],t);switch(a){case"GET":o=d;break;case"SET":u[c.slice(-1)[0]]=m(i.data.value),o=!0;break;case"APPLY":o=d.apply(u,f);break;case"CONSTRUCT":{const n=new d(...f);o=B(n)}break;case"ENDPOINT":{const{port1:n,port2:g}=new MessageChannel;O(t,g),o=at(n,[n])}break;case"RELEASE":o=void 0;break;default:return}}catch(u){o={value:u,[x]:0}}Promise.resolve(o).catch(u=>({value:u,[x]:0})).then(u=>{const[d,n]=M(u);e.postMessage(Object.assign(Object.assign({},d),{id:l}),n),a==="RELEASE"&&(e.removeEventListener("message",s),G(e),T in t&&typeof t[T]=="function"&&t[T]())}).catch(u=>{const[d,n]=M({value:new TypeError("Unserializable return value"),[x]:0});e.postMessage(Object.assign(Object.assign({},d),{id:l}),n)})}),e.start&&e.start()}function v(t){return t.constructor.name==="MessagePort"}function G(t){v(t)&&t.close()}function tt(t,e){return D(t,[],e)}function b(t){if(t)throw new Error("Proxy has been released and is not useable")}function X(t){return y(t,{type:"RELEASE"}).then(()=>{G(t)})}const k=new WeakMap,S="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(k.get(t)||0)-1;k.set(t,e),e===0&&X(t)});function et(t,e){const r=(k.get(e)||0)+1;k.set(e,r),S&&S.register(t,e,t)}function rt(t){S&&S.unregister(t)}function D(t,e=[],r=function(){}){let s=!1;const i=new Proxy(r,{get(l,a){if(b(s),a===J)return()=>{rt(i),X(t),s=!0};if(a==="then"){if(e.length===0)return{then:()=>i};const c=y(t,{type:"GET",path:e.map(f=>f.toString())}).then(m);return c.then.bind(c)}return D(t,[...e,a])},set(l,a,c){b(s);const[f,o]=M(c);return y(t,{type:"SET",path:[...e,a].map(u=>u.toString()),value:f},o).then(m)},apply(l,a,c){b(s);const f=e[e.length-1];if(f===$)return y(t,{type:"ENDPOINT"}).then(m);if(f==="bind")return D(t,e.slice(0,-1));const[o,u]=Y(c);return y(t,{type:"APPLY",path:e.map(d=>d.toString()),argumentList:o},u).then(m)},construct(l,a){b(s);const[c,f]=Y(a);return y(t,{type:"CONSTRUCT",path:e.map(o=>o.toString()),argumentList:c},f).then(m)}});return et(i,t),i}function nt(t){return Array.prototype.concat.apply([],t)}function Y(t){const e=t.map(M);return[e.map(r=>r[0]),nt(e.map(r=>r[1]))]}const q=new WeakMap;function at(t,e){return q.set(t,e),t}function B(t){return Object.assign(t,{[V]:!0})}function M(t){for(const[e,r]of U)if(r.canHandle(t)){const[s,i]=r.serialize(t);return[{type:"HANDLER",name:e,value:s},i]}return[{type:"RAW",value:t},q.get(t)||[]]}function m(t){switch(t.type){case"HANDLER":return U.get(t.name).deserialize(t.value);case"RAW":return t.value}}function y(t,e,r){return new Promise(s=>{const i=it();t.addEventListener("message",function l(a){!a.data||!a.data.id||a.data.id!==i||(t.removeEventListener("message",l),s(a.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:i},e),r)})}function it(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function st(t,e){let r=null,s;const i=()=>{s=new OffscreenCanvas(e.image.width,e.image.height),s.getContext("2d").putImageData(e.image,0,0)};i();let l=_(e.colorLight),a=_(e.colorDark);const c=t.getContext("2d"),f=()=>{c.drawImage(s,0,0,e.output_width,e.output_height);const n=c.getImageData(0,0,e.output_width,e.output_height);for(let g=0;g<e.output_height;g++)for(let P=0;P<e.output_width;P++){const w=(g*e.output_width+P)*4,I=n.data[w+0],z=n.data[w+1],N=n.data[w+2];let C,A,L;if(e.monochrome){const h=(I+z+N)/3;C=h>127?l[0]:a[0],A=h>127?l[1]:a[1],L=h>127?l[2]:a[2]}else C=I>127?255:0,A=z>127?255:0,L=N>127?255:0;const ot=(I-C)*e.diffusionStrength/2,ct=(z-A)*e.diffusionStrength/2,ut=(N-L)*e.diffusionStrength/2;n.data[w+0]=C,n.data[w+1]=A,n.data[w+2]=L;for(let h=0;h<e.diffusionMatrix.length;h++)for(let p=0;p<e.diffusionMatrix[0].length;p++){const H=P+p-e.diffusionMatrixOriginX,W=g+h;if(H<0||H>=e.output_width||W<0||W>=e.output_height)continue;const E=(W*n.width+H)*4,F=e.diffusionMatrix[h][p];n.data[E+0]=R(n.data[E+0]+ot*F*e.diffusionStrength,0,255),n.data[E+1]=R(n.data[E+1]+ct*F*e.diffusionStrength,0,255),n.data[E+2]=R(n.data[E+2]+ut*F*e.diffusionStrength,0,255)}}c.putImageData(n,0,0)},o=()=>{r===null&&(r=requestAnimationFrame(()=>{r=null,f()}))};return o(),B({update:n=>{const g=n.image!==e.image;e=n,t.width=e.output_width,t.height=e.output_height,l=_(e.colorLight),a=_(e.colorDark),g&&i(),o()},destroy:()=>{r!==null&&cancelAnimationFrame(r)}})}O({errorDiffusionDithering:st});function _(t){const e=parseInt(t.slice(1,3),16),r=parseInt(t.slice(3,5),16),s=parseInt(t.slice(5,7),16);return[e,r,s]}})();
