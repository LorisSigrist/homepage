(function(){"use strict";function k(t,e,r){return Math.min(Math.max(t,e),r)}/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const T=Symbol("Comlink.proxy"),G=Symbol("Comlink.endpoint"),q=Symbol("Comlink.releaseProxy"),_=Symbol("Comlink.finalizer"),w=Symbol("Comlink.thrown"),L=t=>typeof t=="object"&&t!==null||typeof t=="function",$={canHandle:t=>L(t)&&t[T],serialize(t){const{port1:e,port2:r}=new MessageChannel;return C(t,e),[r,[r]]},deserialize(t){return t.start(),Q(t)}},B={canHandle:t=>L(t)&&w in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},D=new Map([["proxy",$],["throw",B]]);function J(t,e){for(const r of t)if(e===r||r==="*"||r instanceof RegExp&&r.test(e))return!0;return!1}function C(t,e=globalThis,r=["*"]){e.addEventListener("message",function i(a){if(!a||!a.data)return;if(!J(r,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:u,type:s,path:o}=Object.assign({path:[]},a.data),g=(a.data.argumentList||[]).map(h);let l;try{const n=o.slice(0,-1).reduce((c,d)=>c[d],t),f=o.reduce((c,d)=>c[d],t);switch(s){case"GET":l=f;break;case"SET":n[o.slice(-1)[0]]=h(a.data.value),l=!0;break;case"APPLY":l=f.apply(n,g);break;case"CONSTRUCT":{const c=new f(...g);l=W(c)}break;case"ENDPOINT":{const{port1:c,port2:d}=new MessageChannel;C(t,d),l=et(c,[c])}break;case"RELEASE":l=void 0;break;default:return}}catch(n){l={value:n,[w]:0}}Promise.resolve(l).catch(n=>({value:n,[w]:0})).then(n=>{const[f,c]=M(n);e.postMessage(Object.assign(Object.assign({},f),{id:u}),c),s==="RELEASE"&&(e.removeEventListener("message",i),I(e),_ in t&&typeof t[_]=="function"&&t[_]())}).catch(n=>{const[f,c]=M({value:new TypeError("Unserializable return value"),[w]:0});e.postMessage(Object.assign(Object.assign({},f),{id:u}),c)})}),e.start&&e.start()}function K(t){return t.constructor.name==="MessagePort"}function I(t){K(t)&&t.close()}function Q(t,e){return p(t,[],e)}function x(t){if(t)throw new Error("Proxy has been released and is not useable")}function z(t){return m(t,{type:"RELEASE"}).then(()=>{I(t)})}const E=new WeakMap,b="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(E.get(t)||0)-1;E.set(t,e),e===0&&z(t)});function Z(t,e){const r=(E.get(e)||0)+1;E.set(e,r),b&&b.register(t,e,t)}function v(t){b&&b.unregister(t)}function p(t,e=[],r=function(){}){let i=!1;const a=new Proxy(r,{get(u,s){if(x(i),s===q)return()=>{v(a),z(t),i=!0};if(s==="then"){if(e.length===0)return{then:()=>a};const o=m(t,{type:"GET",path:e.map(g=>g.toString())}).then(h);return o.then.bind(o)}return p(t,[...e,s])},set(u,s,o){x(i);const[g,l]=M(o);return m(t,{type:"SET",path:[...e,s].map(n=>n.toString()),value:g},l).then(h)},apply(u,s,o){x(i);const g=e[e.length-1];if(g===G)return m(t,{type:"ENDPOINT"}).then(h);if(g==="bind")return p(t,e.slice(0,-1));const[l,n]=N(o);return m(t,{type:"APPLY",path:e.map(f=>f.toString()),argumentList:l},n).then(h)},construct(u,s){x(i);const[o,g]=N(s);return m(t,{type:"CONSTRUCT",path:e.map(l=>l.toString()),argumentList:o},g).then(h)}});return Z(a,t),a}function tt(t){return Array.prototype.concat.apply([],t)}function N(t){const e=t.map(M);return[e.map(r=>r[0]),tt(e.map(r=>r[1]))]}const H=new WeakMap;function et(t,e){return H.set(t,e),t}function W(t){return Object.assign(t,{[T]:!0})}function M(t){for(const[e,r]of D)if(r.canHandle(t)){const[i,a]=r.serialize(t);return[{type:"HANDLER",name:e,value:i},a]}return[{type:"RAW",value:t},H.get(t)||[]]}function h(t){switch(t.type){case"HANDLER":return D.get(t.name).deserialize(t.value);case"RAW":return t.value}}function m(t,e,r){return new Promise(i=>{const a=rt();t.addEventListener("message",function u(s){!s.data||!s.data.id||s.data.id!==a||(t.removeEventListener("message",u),i(s.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:a},e),r)})}function rt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function nt(t,e){e=e.map(g=>Math.floor(g/16)*16);const[r,i]=at(e),a=4*(i*t.width+r),u=t.data[a],s=t.data[a+1],o=t.data[a+2];return[u,s,o]}function at(t){const[e,r,i]=t,a=Math.floor((e+r*16+i*16*16)/16),u=Math.floor(a/64),s=Math.floor(a%64);return[u,s]}function st(t,e){let r=null,i;const a=()=>{i=new OffscreenCanvas(e.image.width,e.image.height),i.getContext("2d").putImageData(e.image,0,0)};a();const u=t.getContext("2d"),s=()=>{u.drawImage(i,0,0,e.output_width,e.output_height);const n=u.getImageData(0,0,e.output_width,e.output_height);for(let f=0;f<e.output_height;f++)for(let c=0;c<e.output_width;c++){const d=(f*e.output_width+c)*4,F=n.data[d+0],V=n.data[d+1],j=n.data[d+2],[U,X,Y]=nt(e.palette,[F,V,j]);n.data[d+0]=U,n.data[d+1]=X,n.data[d+2]=Y;const it=(F-U)*e.diffusionStrength/2,ot=(V-X)*e.diffusionStrength/2,ct=(j-Y)*e.diffusionStrength/2;for(let S=0;S<e.diffusionMatrix.length;S++)for(let P=0;P<e.diffusionMatrix[0].length;P++){const A=c+P-e.diffusionMatrixOriginX,O=f+S;if(A<0||A>=e.output_width||O<0||O>=e.output_height)continue;const y=(O*n.width+A)*4,R=e.diffusionMatrix[S][P];n.data[y+0]=k(n.data[y+0]+it*R*e.diffusionStrength,0,255),n.data[y+1]=k(n.data[y+1]+ot*R*e.diffusionStrength,0,255),n.data[y+2]=k(n.data[y+2]+ct*R*e.diffusionStrength,0,255)}}u.putImageData(n,0,0)},o=()=>{r===null&&(r=requestAnimationFrame(()=>{r=null,s()}))};return o(),W({update:n=>{const f=n.image!==e.image;e=n,t.width=e.output_width,t.height=e.output_height,f&&a(),o()},destroy:()=>{r!==null&&cancelAnimationFrame(r)}})}C({errorDiffusionDithering:st})})();
