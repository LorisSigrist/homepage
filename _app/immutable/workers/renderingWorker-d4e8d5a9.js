(function(){"use strict";function k(t,e,r){return Math.min(Math.max(t,e),r)}/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const D=Symbol("Comlink.proxy"),G=Symbol("Comlink.endpoint"),U=Symbol("Comlink.releaseProxy"),C=Symbol("Comlink.finalizer"),w=Symbol("Comlink.thrown"),z=t=>typeof t=="object"&&t!==null||typeof t=="function",X={canHandle:t=>z(t)&&t[D],serialize(t){const{port1:e,port2:r}=new MessageChannel;return A(t,e),[r,[r]]},deserialize(t){return t.start(),v(t)}},Y={canHandle:t=>z(t)&&w in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},N=new Map([["proxy",X],["throw",Y]]);function q(t,e){for(const r of t)if(e===r||r==="*"||r instanceof RegExp&&r.test(e))return!0;return!1}function A(t,e=globalThis,r=["*"]){e.addEventListener("message",function o(a){if(!a||!a.data)return;if(!q(r,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:u,type:s,path:c}=Object.assign({path:[]},a.data),l=(a.data.argumentList||[]).map(m);let f;try{const g=c.slice(0,-1).reduce((i,d)=>i[d],t),n=c.reduce((i,d)=>i[d],t);switch(s){case"GET":f=n;break;case"SET":g[c.slice(-1)[0]]=m(a.data.value),f=!0;break;case"APPLY":f=n.apply(g,l);break;case"CONSTRUCT":{const i=new n(...l);f=j(i)}break;case"ENDPOINT":{const{port1:i,port2:d}=new MessageChannel;A(t,d),f=Q(i,[i])}break;case"RELEASE":f=void 0;break;default:return}}catch(g){f={value:g,[w]:0}}Promise.resolve(f).catch(g=>({value:g,[w]:0})).then(g=>{const[n,i]=_(g);e.postMessage(Object.assign(Object.assign({},n),{id:u}),i),s==="RELEASE"&&(e.removeEventListener("message",o),H(e),C in t&&typeof t[C]=="function"&&t[C]())}).catch(g=>{const[n,i]=_({value:new TypeError("Unserializable return value"),[w]:0});e.postMessage(Object.assign(Object.assign({},n),{id:u}),i)})}),e.start&&e.start()}function B(t){return t.constructor.name==="MessagePort"}function H(t){B(t)&&t.close()}function v(t,e){return R(t,[],e)}function x(t){if(t)throw new Error("Proxy has been released and is not useable")}function W(t){return h(t,{type:"RELEASE"}).then(()=>{H(t)})}const E=new WeakMap,b="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(E.get(t)||0)-1;E.set(t,e),e===0&&W(t)});function $(t,e){const r=(E.get(e)||0)+1;E.set(e,r),b&&b.register(t,e,t)}function J(t){b&&b.unregister(t)}function R(t,e=[],r=function(){}){let o=!1;const a=new Proxy(r,{get(u,s){if(x(o),s===U)return()=>{J(a),W(t),o=!0};if(s==="then"){if(e.length===0)return{then:()=>a};const c=h(t,{type:"GET",path:e.map(l=>l.toString())}).then(m);return c.then.bind(c)}return R(t,[...e,s])},set(u,s,c){x(o);const[l,f]=_(c);return h(t,{type:"SET",path:[...e,s].map(g=>g.toString()),value:l},f).then(m)},apply(u,s,c){x(o);const l=e[e.length-1];if(l===G)return h(t,{type:"ENDPOINT"}).then(m);if(l==="bind")return R(t,e.slice(0,-1));const[f,g]=F(c);return h(t,{type:"APPLY",path:e.map(n=>n.toString()),argumentList:f},g).then(m)},construct(u,s){x(o);const[c,l]=F(s);return h(t,{type:"CONSTRUCT",path:e.map(f=>f.toString()),argumentList:c},l).then(m)}});return $(a,t),a}function K(t){return Array.prototype.concat.apply([],t)}function F(t){const e=t.map(_);return[e.map(r=>r[0]),K(e.map(r=>r[1]))]}const V=new WeakMap;function Q(t,e){return V.set(t,e),t}function j(t){return Object.assign(t,{[D]:!0})}function _(t){for(const[e,r]of N)if(r.canHandle(t)){const[o,a]=r.serialize(t);return[{type:"HANDLER",name:e,value:o},a]}return[{type:"RAW",value:t},V.get(t)||[]]}function m(t){switch(t.type){case"HANDLER":return N.get(t.name).deserialize(t.value);case"RAW":return t.value}}function h(t,e,r){return new Promise(o=>{const a=Z();t.addEventListener("message",function u(s){!s.data||!s.data.id||s.data.id!==a||(t.removeEventListener("message",u),o(s.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:a},e),r)})}function Z(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function tt(t,e){const r=e[0]>>4,o=e[1]>>4,a=e[2]>>4,u=r+(o<<4)+(a<<8),s=u>>6,l=(u&63)*t.width+s<<2;return t.data.slice(l,l|3)}function et(t,e){let r=null,o;const a=()=>{o=new OffscreenCanvas(e.image.width,e.image.height),o.getContext("2d").putImageData(e.image,0,0)};a();const u=t.getContext("2d"),s=()=>{u.drawImage(o,0,0,e.output_width,e.output_height);const n=u.getImageData(0,0,e.output_width,e.output_height);for(let i=0;i<e.output_height;i++)for(let d=0;d<e.output_width;d++){const I=i*e.output_width+d<<2,S=n.data.slice(I,I|3),M=tt(e.palette,S);n.data.set(M,I);const rt=(S[0]-M[0])*e.diffusionStrength/2,nt=(S[1]-M[1])*e.diffusionStrength/2,at=(S[2]-M[2])*e.diffusionStrength/2;for(let P=0;P<e.diffusionMatrix.length;P++)for(let p=0;p<e.diffusionMatrix[0].length;p++){const O=d+p-e.diffusionMatrixOriginX,T=i+P;if(O<0||O>=e.output_width||T<0||T>=e.output_height)continue;const y=T*n.width+O<<2,L=e.diffusionMatrix[P][p];n.data[y]=k(n.data[y]+rt*L*e.diffusionStrength,0,255),n.data[y|1]=k(n.data[y|1]+nt*L*e.diffusionStrength,0,255),n.data[y|2]=k(n.data[y|2]+at*L*e.diffusionStrength,0,255)}}u.putImageData(n,0,0)},c=()=>{r===null&&(r=requestAnimationFrame(()=>{r=null,s()}))};return c(),j({update:n=>{const i=n.image!==e.image;e=n,t.width=e.output_width,t.height=e.output_height,i&&a(),c()},updateImage:n=>{e.image=n,a(),c()},destroy:()=>{r!==null&&cancelAnimationFrame(r)}})}A({errorDiffusionDithering:et})})();
