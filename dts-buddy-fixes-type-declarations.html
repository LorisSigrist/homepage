<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <link href=./favicon.png rel=icon> <meta content="width=device-width" name=viewport> <meta content="" http-equiv=content-security-policy> <link href=./_app/immutable/assets/0.36a92c50.css rel=stylesheet> <link href=./_app/immutable/assets/2.37abdfb3.css rel=stylesheet> <link href=./_app/immutable/entry/start.467f6e0b.js rel=modulepreload> <link href=./_app/immutable/chunks/index.4190156f.js rel=modulepreload> <link href=./_app/immutable/chunks/singletons.731db61c.js rel=modulepreload> <link href=./_app/immutable/chunks/index.c3b38f65.js rel=modulepreload> <link href=./_app/immutable/entry/app.86ff35ab.js rel=modulepreload> <link href=./_app/immutable/nodes/0.3df2b1de.js rel=modulepreload> <link href=./_app/immutable/chunks/stores.490749b3.js rel=modulepreload> <link href=./_app/immutable/chunks/theme.de549241.js rel=modulepreload> <link href=./_app/immutable/nodes/2.def2ed7e.js rel=modulepreload> <link href=./_app/immutable/nodes/5.bc05654f.js rel=modulepreload><title>dts-buddy fixes type declarations</title><!-- HEAD_svelte-1quh51c_START --><script>if("localStorage"in window){const a="dark"===localStorage.getItem("theme"),b="light"===localStorage.getItem("theme"),c=!a&&!b;if(a)document.documentElement.classList.add("dark");else if(b)document.documentElement.classList.remove("dark");else if(c){const d=window.matchMedia("(prefers-color-scheme: dark)");d.matches?(document.documentElement.classList.add("dark"),localStorage.setItem("theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("theme","light"))}}</script><!-- HEAD_svelte-1quh51c_END --><!-- HEAD_svelte-13v8b90_START --><meta content="dts-buddy fixes type declarations" name=og:title><meta content="dts-buddy fixes type declarations" name=twitter:title><meta content=website name=og:type><meta content=/og/dts-buddy%20fixes%20type%20declarations.png name=og:image><meta content="dts-buddy is a bundler for type-definitions. It helps sidestep the most common issues with type definitions." name=description><meta content="Loris Sigrist" name=author><meta content=2023-07-16T00:00:00.000Z name=date><!-- HEAD_svelte-13v8b90_END --> </head> <body data-sveltekit-preload-data=hover> <header class="flex flex-row container justify-between mx-auto print:hidden px-4 py-4"><div class="flex flex-row items-center gap-4" id=header-start><a href=/ class="flex flex-row items-center gap-3"><img alt="Loris Sigrist looking very handsome" class="aspect-square rounded-full w-9" height=412 src=/_app/immutable/assets/avatar.4558b389.png style=background-color:#ababab width=412> <span class="font-bold text-md">Loris Sigrist</span></a></div> <div class="flex flex-row items-center gap-2 sm:gap-4" id=header-end><a href=https://www.github.com/LorisSigrist class="flex items-center gap-2 dark:text-gray-200 hover:bg-gray-100 hover:dark:bg-gray-800 p-1 rounded-md sm:px-3 text-gray-800" target=_blank><span><svg class="h-4 w-4" fill=none height=1024 viewBox="0 0 1024 1024" width=1024 xmlns=http://www.w3.org/2000/svg><path d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" clip-rule=evenodd fill=currentColor fill-rule=evenodd transform=scale(64)></path></svg></span> <span class="hidden sm:block">Github</span></a> <button class="aspect-square hover:bg-gray-100 hover:dark:bg-gray-800 p-2 rounded-md" title="Toggle Theme"> <div class="contents dark:hidden"><svg class="h-4 w-4 block" fill=none height=100% viewBox="0 0 24 24" width=100% xmlns=http://www.w3.org/2000/svg aria-hidden=true slot=light stroke=currentColor stroke-width=1.5><path d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" stroke-linecap=round stroke-linejoin=round></path></svg></div> <div class="hidden dark:contents"><svg class="h-4 w-4 block" fill=none height=100% viewBox="0 0 24 24" width=100% xmlns=http://www.w3.org/2000/svg aria-hidden=true slot=dark stroke=currentColor stroke-width=1.5><path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" stroke-linecap=round stroke-linejoin=round></path></svg></div></button></div></header> <article class="container mx-auto px-4 dark:prose-invert my-8 print:m-0 print:p-0 print:w-100 prose prose-slate"><h1 id=dts-buddy-fixes-type-declarations><a href=#dts-buddy-fixes-type-declarations>DTS-Buddy fixes Type-Declarations</a></h1> <p>There are some common pitfalls surrounding type-declarations that pretty much all TypeScript packages fall into, especially ones subpackages. <a href=https://www.npmjs.com/package/dts-buddy target=_blank rel="noopener noreferrer"><code>dts-buddy</code></a> is a tool that helps you avoid them.</p> <h2 id=what-is-a-type-declaration><a href=#what-is-a-type-declaration>What is a type-declaration?</a></h2> <p>If you know what a type-declaration is, you can <a href=#the-pitfalls>skip this section</a>.</p> <p>When you author a package with types, be it using TypeScript or JSdoc, you need to publish a type-declaration file along with your package for users to actually be able to use your types. The user’s IDE will not bother to look at your source code to infer types, it will only look at the type-declaration file.</p> <p>These files are the <code>.d.ts</code> files you see in most packages. They are usually generated by the TypeScript compiler. They contain just the types of your package, not the actual implementation.</p> <h2 id=the-pitfalls><a href=#the-pitfalls>The Pitfalls</a></h2> <p>If you are just using the TypeScript compiler to generate your type-declarations, you will almost certainly run into most of these pitfalls.</p> <h3 id=1-leaking-internal-types><a href=#1-leaking-internal-types>1. Leaking internal types</a></h3> <p>The TypeScript compiler will generate type-declarations for all types that are exported from your package, including the ones that aren’t meant to be used by consumers of your package. This increases the size of your package unnecessarily, and may, in the worst case, clutter up the user’s IDE with types that are not meant to be used.</p> <h3 id=2-go-to-definition-doesnt-work><a href=#2-go-to-definition-doesnt-work>2. “Go to definition” doesn’t work</a></h3> <p>When people are using your package, they might want to see the implementation of a type. This doesn’t work for most TypeScript packages, as the IDE has no idea how to map the Type-Declarations to the actual source code. This is because the TypeScript compiler doesn’t generate source maps by default.</p> <h2 id=the-solution><a href=#the-solution>The Solution</a></h2> <p><code>dts-buddy</code> solves all these things in a very clever way. Instead of associating the type-declarations with the JS build-output, relying on the module-resolution to match the two, it generates just one <code>.d.ts</code> file for the entire package. This is then referenced by the <code>types</code> field in your <code>package.json</code>. The file contains module declarations for the public interface of the package and it’s subpackages, using the <code>declare module</code> syntax. Here’s an example output it generated for one of my (private, sorry) packages:</p> <pre class=language-ts><!-- HTML_TAG_START --><code class=language-ts><span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'@sigrist.dev/jspdf-helpers/esr'</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
    * Adds a QR-ESR Invoice footer to the given PDF.
    * 
    * Assumes the current page has A4 portrait format.
    * 
    * @see https://www.swiss-qr-invoice.org/validator/?lang=de for a validator
    */</span>
    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addQrEsrFooter</span><span class="token punctuation">(</span>pdf<span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"jspdf"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>jsPDF<span class="token punctuation">,</span> data<span class="token operator">:</span> ESRData<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"jspdf"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>jsPDF<span class="token punctuation">;</span>

    <span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ESRData</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        reference<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'@sigrist.dev/jspdf-helpers/postage'</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code><!-- HTML_TAG_END --></pre> <p>Alongside this, it also generates a <code>.map.d.ts</code> file, which maps the public types onto the actual source code. This allows the IDE to “go to definition” and “peek definition” reliably.</p> <h2 id=should-you-use-it><a href=#should-you-use-it>Should you use it?</a></h2> <p>If you are writing a package with subpackages, you should absolutely use it. It blows the alternatives out of the water. </p> <p>If you are writing a package without subpackages it’s not super important that you use it, but there is still the benefit of smaller package-size and nicer “go to definition”. If you have a lot of users it might be worth it.</p> <p>If you are writing an application, you probably don’t need it, as you don’t publish your types anyway.</article> <script>{__sveltekit_11o66qg={base:new URL(".",location).pathname.slice(0,-1),env:{}};const a=document.currentScript.parentElement,b=[null,null,{type:"data",data:{title:"dts-buddy fixes type declarations",description:"dts-buddy is a bundler for type-definitions. It helps sidestep the most common issues with type definitions.",published:new Date(16894656e5),author:"Loris Sigrist",draft:!0},uses:{}}];Promise.all([import("./_app/immutable/entry/start.467f6e0b.js"),import("./_app/immutable/entry/app.86ff35ab.js")]).then(([e,t])=>{e.start(t,a,{node_ids:[0,2,5],data:b,form:null,error:null})}),"serviceWorker"in navigator&&addEventListener("load",function(){navigator.serviceWorker.register("./service-worker.js")})}</script> 